<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hex Fluency Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(180deg,#050003 0%, #0b0008 100%);
      color: #e6e1ea;
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1, h2 { margin-top: 0; }
    .card {
      background: linear-gradient(180deg,#06040a,#0b0710);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.6);
      width: 100%;
      max-width: 960px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    label { display: block; margin-top: .5rem; }
    input, select, button {
      margin-top: .5rem;
      padding: .5rem .75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
    }
    input, select {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
    }
    button {
      background: #7c2bd6;
      color: white;
      cursor: pointer;
    }
    button.secondary { background: #3f214a; }
    .row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .hidden { display: none; }
    .question {
      font-size: 3rem;
      margin: 1rem 0;
      font-family: ui-monospace, monospace;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-align: center;
    }
    canvas { background: #070511; border-radius: 8px; }
    #answer { font-size: 1.25rem; padding: .75rem .9rem; width: 60%; max-width: 520px; text-align: center; }
    h1 { text-align: center; margin-bottom: 1rem; }
    .row { align-items: center; }
    #history { order: 99; }
    #chart { width: 100%; height: 160px; display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #334155; padding: 0.5rem; text-align: left; }
    .card table, .card canvas { width: 100%; }
  </style>
</head>
<body>

<h1>Hex Fluency Trainer</h1>

<div id="setup" class="card">
  <h2>Session Setup</h2>
  <div class="row">
    <label>Mode
      <select id="mode">
        <option value="hex-dec">Hex → Dec</option>
        <option value="dec-hex">Dec → Hex</option>
        <option value="mixed">Mixed</option>
      </select>
    </label>
    <label>Bit Width
      <select id="bits">
        <option value="8">8-bit</option>
        <option value="16">16-bit</option>
        <option value="32">32-bit</option>
      </select>
    </label>
    <label>Questions
      <input id="count" type="number" value="20" min="1" max="200" />
    </label>
  </div>
  <button onclick="startSession()">Start</button>
</div>

<div id="quiz" class="card hidden">
  <div id="progress"></div>
  <div id="question" class="question"></div>
  <input id="answer" autocomplete="off" />
  <div class="row">
    <button onclick="submitAnswer()">Submit</button>
    <button class="secondary" onclick="skipQuestion()">Skip</button>
    <button class="secondary" onclick="endSession()">Abandon Round</button>
  </div>
</div>

<div id="results" class="card hidden">
  <h2>Results</h2>
  <div id="summary"></div>
  <table>
    <thead><tr><th>#</th><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Time (s)</th><th>Correct</th></tr></thead>
    <tbody id="resultsBody"></tbody>
  </table>
  <button class="secondary" onclick="reset()">New Session</button>
</div>

<div id="history" class="card">
  <h2>History</h2>
  <canvas id="chart"></canvas>
  <div id="historyList"></div>
  <div style="margin-top:.5rem">
    <button class="secondary" onclick="clearHistory()">Clear History</button>
  </div>
</div>

<script>
let session = null;
let startTime = 0;
let askedNumbers = new Set();

function rand(max) {
  return Math.floor(Math.random() * max);
}

function nextQuestion() {
  const max = 2 ** session.bits;
  let value;
  do {
    value = rand(max);
  } while (askedNumbers.has(value));
  askedNumbers.add(value);

  const mode = session.mode === 'mixed'
    ? (Math.random() < 0.5 ? 'hex-dec' : 'dec-hex')
    : session.mode;

  session.current = { value, mode, askedAt: performance.now() };

  const q = mode === 'hex-dec' ? '0x' + value.toString(16) : value.toString(10);
  document.getElementById('progress').textContent = `Question ${session.index+1} / ${session.count}`;
  document.getElementById('question').textContent = q;
  document.getElementById('answer').value = '';
  document.getElementById('answer').focus();
}

function sanitizeInput(input, mode) {
  input = input.trim().toLowerCase();
  if (!input) return null;
  if (mode === 'hex-dec') {
    if (!/^\d+$/.test(input)) return null;
    return parseInt(input, 10);
  } else {
    if (input.startsWith('0x')) input = input.slice(2);
    if (!/^[0-9a-f]+$/.test(input)) return null;
    return parseInt(input, 16);
  }
}

function submitAnswer() {
  const rawInput = document.getElementById('answer').value;
  if (!rawInput) { alert('Please enter a value'); return; }
  const { value, mode, askedAt } = session.current;
  const parsed = sanitizeInput(rawInput, mode);
  if (parsed === null) { alert('Invalid input.'); return; }

  const correct = parsed === value;
  session.answers.push({
    question: mode === 'hex-dec' ? '0x'+value.toString(16) : value.toString(10),
    yourAnswer: rawInput,
    correctAnswer: mode==='hex-dec'?String(value):'0x'+value.toString(16),
    time: ((performance.now()-askedAt)/1000).toFixed(2),
    correct
  });

  session.index++;
  if (session.index >= session.count) endSession();
  else nextQuestion();
}

document.getElementById('answer').addEventListener('keydown', e => { if(e.key==='Enter') submitAnswer(); });

function skipQuestion() {
  const { value, mode, askedAt } = session.current;
  session.answers.push({
    question: mode==='hex-dec'?'0x'+value.toString(16):value.toString(10),
    yourAnswer:'(skipped)',
    correctAnswer: mode==='hex-dec'?String(value):'0x'+value.toString(16),
    time:((performance.now()-askedAt)/1000).toFixed(2),
    correct:false
  });
  session.index++;
  if(session.index>=session.count) endSession(); else nextQuestion();
}

function startSession() {
  session={mode:document.getElementById('mode').value,bits:parseInt(document.getElementById('bits').value),count:parseInt(document.getElementById('count').value),index:0,answers:[]};
  askedNumbers.clear();
  document.getElementById('setup').classList.add('hidden');
  document.getElementById('quiz').classList.remove('hidden');
  document.getElementById('history').classList.add('hidden');
  startTime = performance.now();
  nextQuestion();
}

function endSession() {
  const totalTime=(performance.now()-startTime)/1000;
  const correct=session.answers.filter(a=>a.correct).length;
  const avg = session.answers.length ? session.answers.reduce((s,a)=>s+parseFloat(a.time),0)/session.answers.length : 0;

  try{
    let hist = [];
    try {
      const raw = localStorage.getItem('hexHistory');
      hist = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(hist)) hist = [];
    } catch (e) {
      console.error('Failed to parse stored history, starting fresh', e);
      hist = [];
    }
    const correctPct = session.count ? Number(((correct/session.count)*100).toFixed(1)) : 0;
    hist.push({date:Date.now(),mode:session.mode,bits:session.bits,count:session.count,correct,correctPct,totalTime,avg,answers:session.answers});
    try { localStorage.setItem('hexHistory',JSON.stringify(hist)); }
    catch(e){ console.error('Failed to write history to localStorage', e); }
  }catch(e){console.error('LocalStorage error',e);} 

  document.getElementById('quiz').classList.add('hidden');
  document.getElementById('results').classList.remove('hidden');
  document.getElementById('history').classList.remove('hidden');

  document.getElementById('summary').innerHTML=`<p>Correct: ${correct} / ${session.count}</p><p>Total time: ${totalTime.toFixed(2)}s</p><p>Average answer time: ${avg.toFixed(2)}s</p>`;

  const tbody=document.getElementById('resultsBody');
  tbody.innerHTML='';
  session.answers.forEach((a,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${a.question}</td><td>${a.yourAnswer}</td><td>${a.correctAnswer}</td><td>${a.time}</td><td>${a.correct?'✔️':'❌'}</td>`;
    tbody.appendChild(tr);
  });

  drawChart();
  renderHistoryList();
}

function reset() {
  document.getElementById('results').classList.add('hidden');
  document.getElementById('setup').classList.remove('hidden');
  document.getElementById('history').classList.remove('hidden');
  drawChart();
}

function drawChart() {
  const canvas = document.getElementById('chart');
  const ctx = canvas.getContext('2d');
  const cw = canvas.clientWidth || 600;
  const ch = canvas.clientHeight || 160;
  const ratio = window.devicePixelRatio || 1;
  canvas.width = Math.floor(cw * ratio);
  canvas.height = Math.floor(ch * ratio);
  canvas.style.width = cw + 'px';
  canvas.style.height = ch + 'px';
  ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
  ctx.clearRect(0, 0, cw, ch);

  let hist = [];
  try { hist = JSON.parse(localStorage.getItem('hexHistory')||'[]'); } catch(e){ hist = []; }
  if(!Array.isArray(hist) || hist.length === 0) return;

  const mappedTime = hist.map(h => Number(h.avg) || 0);
  const maxTime = Math.max(...mappedTime);

  // compute correct percentage series (0-100)
  const mappedPct = hist.map(h => {
    if (typeof h.correctPct !== 'undefined') return Number(h.correctPct) || 0;
    const c = Number(h.correct) || 0; const cnt = Number(h.count) || 1; return cnt? (c/cnt*100) : 0;
  });
  const maxPct = 100;

  // draw percent as primary series (blue), time as secondary (gray)
  ctx.lineWidth = 2;
  const pointRadius = Math.max(3, Math.min(8, ch * 0.04));

  // percent polyline (magenta)
  ctx.strokeStyle = '#a21caf';
  ctx.fillStyle = '#a21caf';
  ctx.beginPath();
  hist.forEach((h, i) => {
    const x = (i/((hist.length-1)||1))*cw;
    const pct = mappedPct[i] || 0;
    const y = ch - (pct/maxPct)*ch;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  hist.forEach((h,i)=>{
    const x=(i/((hist.length-1)||1))*cw;
    const pct = mappedPct[i]||0;
    const y = ch - (pct/maxPct)*ch;
    ctx.beginPath(); ctx.arc(x,y,pointRadius,0,Math.PI*2); ctx.fill();
  });

  // time polyline (secondary, lighter)
  if (isFinite(maxTime) && maxTime > 0) {
    ctx.strokeStyle = 'rgba(156,39,176,0.9)';
    ctx.fillStyle = 'rgba(156,39,176,0.9)';
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    hist.forEach((h, i) => {
      const x = (i/((hist.length-1)||1))*cw;
      const avgVal = Number(h.avg) || 0;
      const y = ch - (avgVal/maxTime)*(ch*0.6); // compress time series to lower portion
      const yAdj = ch - (ch*0.2) - ( (avgVal/maxTime) * (ch*0.6) );
      if(i===0) ctx.moveTo(x,yAdj); else ctx.lineTo(x,yAdj);
    });
    ctx.stroke();
    hist.forEach((h,i)=>{
      const x=(i/((hist.length-1)||1))*cw;
      const avgVal = Number(h.avg)||0;
      const yAdj = ch - (ch*0.2) - ((avgVal/maxTime)*(ch*0.6));
      ctx.beginPath(); ctx.arc(x,yAdj,Math.max(2, pointRadius-2),0,Math.PI*2); ctx.fill();
    });
  }

  // legend
  ctx.font = '12px system-ui, sans-serif';
  ctx.fillStyle = '#a21caf';
  ctx.fillRect(8,8,10,10);
  ctx.fillStyle = '#e6e1ea'; ctx.fillText('Correct %', 24, 17);
  ctx.fillStyle = 'rgba(156,39,176,0.9)'; ctx.fillRect(110,8,10,10);
  ctx.fillStyle = '#e6e1ea'; ctx.fillText('Avg time (s)', 126, 17);
}

// Show history on main page initially
document.getElementById('history').classList.remove('hidden');
drawChart();
renderHistoryList();

function renderHistoryList(){
  const container = document.getElementById('historyList');
  container.innerHTML = '';
  let hist = [];
  try { hist = JSON.parse(localStorage.getItem('hexHistory')||'[]'); } catch(e){ hist = []; }
  if(!Array.isArray(hist) || hist.length===0){ container.innerHTML = '<p>No history yet.</p>'; return; }

  const table = document.createElement('table');
  table.innerHTML = '<thead><tr><th>Date</th><th>Mode</th><th>Bits</th><th>Count</th><th>Correct</th><th>%</th><th>Total (s)</th><th>Avg (s)</th></tr></thead>';
  const tbody = document.createElement('tbody');
  hist.slice().reverse().forEach(h => {
    const tr = document.createElement('tr');
    const date = new Date(h.date || 0).toLocaleString();
    const pct = (typeof h.correctPct !== 'undefined') ? (Number(h.correctPct)||0) : ((Number(h.correct)||0)/(Number(h.count)||1)*100);
    tr.innerHTML = `<td>${date}</td><td>${h.mode||''}</td><td>${h.bits||''}</td><td>${h.count||''}</td><td>${h.correct||0}</td><td>${pct.toFixed(1)}</td><td>${(Number(h.totalTime)||0).toFixed(2)}</td><td>${(Number(h.avg)||0).toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function clearHistory(){
  if(!confirm('Clear all history?')) return;
  try{ localStorage.removeItem('hexHistory'); } catch(e){ console.error('Failed to clear history', e); }
  drawChart(); renderHistoryList();
}
</script>

</body>
</html>
